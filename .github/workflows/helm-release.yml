name: Helm Chart Release

on:
  workflow_call:
    inputs:
      version:
        description: "Release version (without v prefix, e.g., 1.2.3)"
        required: true
        type: string
      image-tag:
        description: "Docker image tag to reference in the chart"
        required: true
        type: string

env:
  HELM_REPO_URL: https://oss.nextdoor.com/veneer

jobs:
  release:
    name: Release Helm Chart
    runs-on: runs-on=${{ github.run_id }}/runner=2cpu-linux-x64/cache=/var/cache/magic/extras=magic-cache
    permissions:
      contents: write
      packages: write
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4
        with:
          version: v3.16.3

      - name: Add Helm repositories
        run: |
          helm repo add lumina https://oss.nextdoor.com/lumina
          helm repo update

      - name: Update Chart.yaml version and appVersion
        run: |
          VERSION="${{ inputs.version }}"
          sed -i "s/^version:.*/version: ${VERSION}/" charts/veneer/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${VERSION}\"/" charts/veneer/Chart.yaml
          echo "Updated Chart.yaml:"
          cat charts/veneer/Chart.yaml

      - name: Update Helm dependencies
        run: |
          cd charts/veneer
          helm dependency update

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Publish Helm chart to GitHub Pages
        uses: helm/chart-releaser-action@cae68fefc6b5f367a0275617c9f83181ba54714f # v1.7.0
        with:
          charts_dir: charts
          packages_with_index: true
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub release artifacts
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: v${{ inputs.version }}
          files: |
            .cr-release-packages/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
